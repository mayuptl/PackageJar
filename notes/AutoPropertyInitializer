package core.logging;
import org.apache.logging.log4j.core.LoggerContext;
import org.apache.logging.log4j.core.util.ContextInitializer;
import java.io.InputStream;
import java.util.Properties;

/**
 * Automatically executed by Log4j2 via the Java ServiceLoader mechanism.
 */
public class AutoPropertyInitializer implements ContextInitializer {

    private static final String CONFIG_FILE_NAME = "config.properties";
    private static final String SOURCE_LOG_DIR_KEY = "logging.logDir";
    private static final String SOURCE_FILE_NAME_KEY = "logging.fileName";
    private static final String TARGET_LOG4J_DIR_KEY = "log4j2.logDir";
    private static final String TARGET_LOG4J_FILE_KEY = "log4j2.fileName";

    @Override
    public void initialize(LoggerContext context) {
        System.out.println("AutoPropertyInitializer: Starting Log4j property injection...");

        try (InputStream input = Thread.currentThread().getContextClassLoader().getResourceAsStream(CONFIG_FILE_NAME)) {

            if (input == null) {
                System.err.println("AutoPropertyInitializer: Configuration file '" + CONFIG_FILE_NAME + "' not found on classpath. Skipping setup.");
                return;
            }

            Properties configProps = new Properties();
            configProps.load(input);

            // Inject the directory property
            injectProperty(configProps, SOURCE_LOG_DIR_KEY, TARGET_LOG4J_DIR_KEY);
            // Inject the file name property
            injectProperty(configProps, SOURCE_FILE_NAME_KEY, TARGET_LOG4J_FILE_KEY);

        } catch (Exception ex) {
            System.err.println("AutoPropertyInitializer: Failed to load properties: " + ex.getMessage());
        }
    }
    private void injectProperty(Properties source, String sourceKey, String targetKey) {
        if (source.containsKey(sourceKey)) {
            String value = source.getProperty(sourceKey);
            // Only set if the consumer hasn't already set it via a JVM argument (-D...)
            if (System.getProperty(targetKey) == null) {
                System.setProperty(targetKey, value);
                System.out.println("AutoPropertyInitializer: Injected System Property: " + targetKey + " = " + value);
            } else {
                System.out.println("AutoPropertyInitializer: System Property " + targetKey + " already set. Keeping existing value.");
            }
        }
    }
}